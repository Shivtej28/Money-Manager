{% extends 'base.html' %} 
{% block content %}
    <div class="container">
        <h1 class="header-title">YEAR {{ year }}</h1>
        <p class="sub-title">INCOME & EXPENSE SUMMARY</p>
        <p>Expense Percentage: {{ expense_percentage }}</p>
        <p>Remaining Percentage: {{ remaining_percentage }}</p>

        <!-- Year Selection Dropdown -->
        <div class="text-center my-3">
            <label for="yearSelect" class="fw-bold">Select Year:</label>
            <select id="yearSelect" class="form-select w-auto d-inline" onchange="changeYear(this.value)">
                {% for y in available_years %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Summary Cards -->
        <div class="row text-center mt-4">
            <div class="col-md-4">
                <div class="card p-3 bg-info text-white">
                    <h5>TOTAL INCOME</h5>
                    <h3>₹{{ total_income }}</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 bg-danger text-white">
                    <h5>TOTAL EXPENSES</h5>
                    <h3>₹{{ total_expense }}</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 bg-success text-white">
                    <h5>NET BALANCE</h5>
                    <h3>₹{{ net_balance }}</h3>
                </div>
            </div>
        </div>

        <!-- Monthly Overview Table -->
        <div class="card mt-4">
            <div class="card-header bg-secondary text-white text-center">
                <h4>MONTHLY OVERVIEW</h4>
            </div>
            <div class="card-body">
                <table class="table table-bordered text-center">
                    <thead class="bg-light">
                        <tr>
                            <th>MONTH</th>
                            <th>INCOME</th>
                            <th>EXPENSE</th>
                            <th>TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in monthly_overview %}
                        <tr>
                            <td>{{ item.month }}</td>
                            <td>₹ {{ item.income|floatformat:2 }}</td>
                            <td>₹ {{ item.expense|floatformat:2 }}</td>
                            <td {% if item.net_balance < 0 %} class="text-danger" {% endif %}>₹ {{ item.net_balance|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="bg-light">
                        <tr>
                            <th>TOTAL</th>
                            <th>₹ {{ total_income|floatformat:2 }}</th>
                            <th>₹ {{ total_expense|floatformat:2 }}</th>
                            <th>₹ {{ net_balance|floatformat:2 }}</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row my-4">
            <div class="col-md-6">
                <div class="card p-3">
                    <h5 class="text-center">Expense as % of Income</h5>
                    <div class="chart-container">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card p-3">
                    <h5 class="text-center">Income vs Expenses</h5>
                    <div class="chart-container">
                        <canvas id="incomeVsExpenseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Wise Expense Breakdown -->
        <div class="row my-4">
            <div class="col-md-6">
                <div class="card p-3">
                    <h5 class="text-center">Expense Breakdown by Category</h5>
                    <div class="chart-container">
                        <canvas id="categoryExpenseChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card p-3">
                    <h5 class="text-center">Monthly Income & Expense</h5>
                    <canvas id="monthlyIncomeExpenseChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Chart.js Scripts -->
    <script>
        function changeYear(year) {
            window.location.href = `?year=${year}`;
        }

        // Expense Percentage Chart
        const expenseCtx = document.getElementById('expenseChart').getContext('2d');
        new Chart(expenseCtx, {
            type: 'doughnut',
            data: {
                labels: ['Expenses', 'Remaining Income'],
                datasets: [{
                    data: [{{ expense_percentage }},{{ remaining_percentage }}],
                    backgroundColor: ['#dc3545', '#f8f9fa'],
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                cutout: '50%',
                plugins: {
                    legend: { display: false }
                }
            }
        });

        // Income vs Expense Chart
        const incomeVsExpenseCtx = document.getElementById('incomeVsExpenseChart').getContext('2d');
        new Chart(incomeVsExpenseCtx, {
            type: 'bar',
            data: {
                labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                datasets: [
                    {
                        label: 'Income',
                        data: {{ monthly_income }},
                        backgroundColor: '#007bff'
                    },
                    {
                        label: 'Expenses',
                        data: {{ monthly_expense }},
                        backgroundColor: '#dc3545'
                    }
                ]
            }
        });

        // Category Expense Breakdown Chart
        const categoryExpenseCtx = document.getElementById('categoryExpenseChart').getContext('2d');
        new Chart(categoryExpenseCtx, {
            type: 'pie',
            data: {
                labels: {{ category_labels|safe }},
                datasets: [{
                    data: {{ category_values|safe }},
                    backgroundColor: ['#FF5733', '#33FF57', '#5733FF', '#FFC300', '#DAF7A6', '#FF33A1', '#3385FF']
                }]
            }
        });

        var ctx = document.getElementById("monthlyIncomeExpenseChart").getContext("2d");
        var monthlyChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: [
                    "January", "February", "March", "April", "May", "June", 
                    "July", "August", "September", "October", "November", "December"
                ],
                datasets: [
                    {
                        label: "Income",
                        backgroundColor: "#4b6584",
                        data: {{ monthly_income|safe }}
                    },
                    {
                        label: "Expenses",
                        backgroundColor: "#d1a3a3",
                        data: {{ monthly_expense|safe }}
                    },
                    {
                        label: "Total",
                        type: "line",
                        borderColor: "#8b0000",
                        borderWidth: 2,
                        fill: false,
                        data: {{ monthly_net_total|safe }}
                    }
                ]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat("en-IN", { style: "currency", currency: "INR" }).format(value);
                            }
                        }
                    }
                }
            }
        });
    </script>
{% endblock %}
